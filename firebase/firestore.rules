rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== Helper Functions =====
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getRole() {
      return request.auth.token.role;
    }
    
    function isGeneral() {
      return getRole() == 'GENERAL';
    }
    
    function isFarmer() {
      return getRole() == 'FARMER';
    }
    
    function isEnthusiast() {
      return getRole() == 'ENTHUSIAST';
    }
    
    function isAdmin() {
      return request.auth.token.role == 'ADMIN' || 
             request.auth.token.admin == true ||
             request.auth.token.email == 'zionjuvvanapudi@gmail.com' ||
             request.auth.token.email == 'rowdyzion@gmail.com';
    }
    
    function isVerified() {
      return request.auth.token.verified == true;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isPhoneAuthenticated() {
      return request.auth.token.firebase.sign_in_provider == 'phone' || 
             request.auth.token.phone_number != null;
    }
    
    // ===== Products Collection =====
    // GENERAL: Read only | FARMER: Full access | ENTHUSIAST: Read only
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow create: if isFarmer() && request.resource.data.sellerId == request.auth.uid;
      allow update, delete: if isFarmer() && resource.data.sellerId == request.auth.uid;
    }
    
    // ===== Orders Collection =====
    // All roles: Own orders only
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        resource.data.buyerId == request.auth.uid || 
        resource.data.sellerId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.buyerId == request.auth.uid || 
        resource.data.sellerId == request.auth.uid
      );
      allow delete: if false;
    }
    
    // ===== Product Trackings =====
    // GENERAL: Read only (All) | FARMER/ENTHUSIAST: Own trackings
    match /productTrackings/{trackingId} {
      allow read: if isGeneral() || 
        (isAuthenticated() && (
          resource.data.buyerId == request.auth.uid || 
          resource.data.sellerId == request.auth.uid
        ));
      allow create, update: if isFarmer() || isEnthusiast();
      allow delete: if false;
    }
    
    // ===== Farm Assets Collection (Top-Level) =====
    // Farmers and Enthusiasts can read/write their own assets
    match /farm_assets/{assetId} {
      allow read: if isAuthenticated() && resource.data.farmerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.farmerId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.farmerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.farmerId == request.auth.uid;
    }
    
    // ===== Users Collection =====
    // All roles: Read all profiles, write own profile
    // Admins: Can update any user (for verification approval, role changes, etc.)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isOwner(userId) || isAdmin());
    }

    // ===== Verifications Collection =====
    // Users can read/write their own verification data, admins can read
    // Document ID can be userId OR submissionId. Rules check owner field.
    match /verifications/{documentId} {
      // Owners: Read
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Owners: Create (User-submitted fields only, Enum validation)
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasOnly([
          'submissionId', 'userId', 'upgradeType', 'currentRole', 'targetRole', 'currentStatus',
          'documentUrls', 'imageUrls', 'documentTypes', 'farmLocation', 'additionalData', 'submittedAt', 'referenceNumber',
          'applicantName', 'applicantPhone', 'imageTypes', 'farmAddress'
        ]) &&
        request.resource.data.upgradeType in ['GENERAL_TO_FARMER', 'FARMER_VERIFICATION', 'FARMER_TO_ENTHUSIAST'] &&
        request.resource.data.currentRole in ['GENERAL', 'FARMER', 'ENTHUSIAST'];

      // Owners: Update (Evidence fields and submission details for resubmission)
      allow update: if request.auth != null &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'documentUrls', 'imageUrls', 'documentTypes', 'farmLocation', 'additionalData',
          'submissionId', 'upgradeType', 'currentRole', 'targetRole', 'currentStatus', 'submittedAt', 'referenceNumber',
          'applicantName', 'applicantPhone', 'imageTypes', 'farmAddress'
        ]);

      // Admins: Read all
      allow read: if isAdmin();

      // Admins: Update moderation fields only
      allow update: if isAdmin() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'currentStatus', 'reviewedAt', 'reviewedBy', 'rejectionReason'
        ]);
    }

    // ===== Enthusiast Verifications Collection =====
    // Users can read/write their own verification data, admins can read all and update status
    match /enthusiast_verifications/{verificationId} {
      // Owners: Read their own verifications
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Owners: Create their own verifications
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.status == 'PENDING';

      // Admins: Read all
      allow read: if isAdmin();

      // Admins: Update moderation fields only (status, reviewedAt, reviewedBy, rejectionReason)
      allow update: if isAdmin() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'status', 'reviewedAt', 'reviewedBy', 'rejectionReason', 'updatedAt'
        ]);
    }

    // ===== Chat Messages =====
    // All roles: Own chats only
    match /chats/{messageId} {
      allow read: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid
      );
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ===== Posts Collection =====
    // GENERAL: No access | FARMER/ENTHUSIAST: Full access
    match /posts/{postId} {
      allow read: if isFarmer() || isEnthusiast();
      allow create: if (isFarmer() || isEnthusiast()) && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if (isFarmer() || isEnthusiast()) && 
        resource.data.userId == request.auth.uid;
    }
    
    // ===== Bids Collection =====
    // All roles: Read all, create own
    match /bids/{bidId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.bidderId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.bidderId == request.auth.uid;
      allow delete: if false;
    }
    
    // ===== Transfers Collection =====
    // All roles: Parties involved only
    match /transfers/{transferId} {
      allow read: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid
      );
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid
      );
      allow delete: if false;
    }
    
    // ===== Farmer Collections =====

    // Farmer document and subcollections: Accessible by owner regardless of verification status
    // Only LIST_PRODUCT permission (enforced in app code) requires VERIFIED status
    match /farmers/{farmerId} {
      allow read, write: if isOwner(farmerId);

      // Subcollections owned by the farmer
      match /breeding_pairs/{pairId} { allow read, write: if isOwner(farmerId); }
      match /alerts/{alertId} { allow read, write: if isOwner(farmerId); }
      match /dashboard_snapshots/{docId} { allow read, write: if isOwner(farmerId); }
      match /vaccinations/{docId} { allow read, write: if isOwner(farmerId); }
      match /growth_records/{docId} { allow read, write: if isOwner(farmerId); }
      match /quarantine_records/{docId} { allow read, write: if isOwner(farmerId); }
      match /mortality_records/{docId} { allow read, write: if isOwner(farmerId); }
      match /hatching_batches/{docId} { allow read, write: if isOwner(farmerId); }
      match /hatching_logs/{docId} { allow read, write: if isOwner(farmerId); }
      match /batch_summaries/{docId} { allow read, write: if isOwner(farmerId); }
      match /farm_assets/{docId} { allow read, write: if isOwner(farmerId); }
      // Overrides/additions to top-level rules for nested access
      match /daily_logs/{docId} { allow read, write: if isOwner(farmerId); }
      match /tasks/{docId} { allow read, write: if isOwner(farmerId); }
    }

    // Daily Logs: FARMER owns, ENTHUSIAST reads
    match /daily_logs/{logId} {
      allow read: if isFarmer() && resource.data.farmerId == request.auth.uid ||
                     isEnthusiast();
      allow create: if isFarmer() && request.resource.data.farmerId == request.auth.uid;
      allow update, delete: if isFarmer() && resource.data.farmerId == request.auth.uid;
    }

    // Tasks: FARMER owns, ENTHUSIAST reads
    match /tasks/{taskId} {
      allow read: if isFarmer() && resource.data.farmerId == request.auth.uid ||
                     isEnthusiast();
      allow create: if isFarmer() && request.resource.data.farmerId == request.auth.uid;
      allow update, delete: if isFarmer() && resource.data.farmerId == request.auth.uid;
    }

    // ===== Enthusiast Collections =====
    
    // Enthusiast document and migrated/exclusive subcollections
    match /enthusiasts/{userId} {
      allow read, write: if isEnthusiast() && isOwner(userId);

      // Migrated subcollections
      match /farm_assets/{docId} { allow read, write: if isOwner(userId); }
      match /daily_logs/{docId} { allow read, write: if isOwner(userId); }
      match /vaccinations/{docId} { allow read, write: if isOwner(userId); }
      match /growth_records/{docId} { allow read, write: if isOwner(userId); }
      match /mortality_records/{docId} { allow read, write: if isOwner(userId); }
      match /quarantine_records/{docId} { allow read, write: if isOwner(userId); }
      match /breeding_pairs/{docId} { allow read, write: if isOwner(userId); }
      match /alerts/{docId} { allow read, write: if isOwner(userId); }
      match /hatching_batches/{docId} { allow read, write: if isOwner(userId); }
      match /hatching_logs/{docId} { allow read, write: if isOwner(userId); }
      
      // Exclusive subcollections
      match /mating_logs/{logId} { allow read, write: if isEnthusiast() && isOwner(userId); }
      match /egg_collections/{collectionId} { allow read, write: if isEnthusiast() && isOwner(userId); }
      match /dashboard_snapshots/{snapshotId} { allow read, write: if isEnthusiast() && isOwner(userId); }
    }

    // ===== Disputes Collection =====
    // Authenticated users can create, admins can read/write all
    match /disputes/{disputeId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.reportedByUserId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.reportedByUserId == request.auth.uid;
      allow update: if isAdmin(); // Only admins resolve disputes
    }

    // ===== Disease Zones Collection =====
    // Admins manage, Authenticated users read
    match /disease_zones/{zoneId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
